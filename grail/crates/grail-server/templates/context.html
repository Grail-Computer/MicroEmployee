{% extends "layout.html" %}
{% block title %}Grail | Context{% endblock %}
{% block content %}
  <h2>Context</h2>
  <p class="section-desc">
    Durable files under <span class="pill">/data/context</span> visible to the agent. Click folders to expand, files to view.
  </p>

  <div id="file-tree"></div>

  <style>
    .tree-dir {
      cursor: pointer;
      user-select: none;
    }
    .tree-dir-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }
    .tree-dir-label:hover {
      color: var(--accent);
    }
    .tree-chevron {
      display: inline-block;
      width: 16px;
      height: 16px;
      transition: transform 120ms ease;
      flex-shrink: 0;
    }
    .tree-chevron.open {
      transform: rotate(90deg);
    }
    .tree-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      opacity: 0.5;
    }
    .tree-children {
      margin-left: 20px;
      border-left: 1px solid var(--border);
      padding-left: 12px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 200ms ease;
    }
    .tree-children.open {
      max-height: 99999px;
    }
    .tree-file {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 0;
    }
    .tree-file-link {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      text-decoration: none;
      flex: 1;
    }
    .tree-file-link:hover {
      color: var(--accent);
    }
    .tree-file-size {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-tertiary);
      flex-shrink: 0;
      min-width: 60px;
      text-align: right;
    }
    .tree-file-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }
    .tree-file-actions a {
      font-size: 12px;
      color: var(--text-secondary);
      text-decoration: none;
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
      transition: all 120ms;
    }
    .tree-file-actions a:hover {
      color: var(--accent);
      border-color: var(--accent);
    }
    .tree-root > .tree-file,
    .tree-root > .tree-dir {
      border-bottom: 1px solid var(--border);
    }
    .tree-root > .tree-file:last-child,
    .tree-root > .tree-dir:last-child {
      border-bottom: none;
    }

    /* Icons as inline SVGs */
    .icon-chevron { color: var(--text-secondary); }
    .icon-folder { color: var(--accent); opacity: 0.7; }
    .icon-file { color: var(--text-secondary); opacity: 0.5; }
  </style>

  <script>
    (function() {
      // File data from server
      var files = [
        {% for f in files %}
        {
          path: "{{ f.path }}",
          bytes: "{{ f.bytes }}",
          editUrl: "{{ f.edit_url }}",
          viewUrl: "{{ f.view_url }}"
        },
        {% endfor %}
      ];

      // Build tree structure
      function buildTree(files) {
        var root = { dirs: {}, files: [] };
        files.forEach(function(f) {
          var parts = f.path.split('/');
          var node = root;
          for (var i = 0; i < parts.length - 1; i++) {
            if (!node.dirs[parts[i]]) {
              node.dirs[parts[i]] = { dirs: {}, files: [] };
            }
            node = node.dirs[parts[i]];
          }
          node.files.push({
            name: parts[parts.length - 1],
            bytes: f.bytes,
            editUrl: f.editUrl,
            viewUrl: f.viewUrl
          });
        });
        return root;
      }

      var chevronSvg = '<svg class="tree-chevron icon-chevron" viewBox="0 0 16 16" fill="currentColor"><path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"/></svg>';
      var folderSvg = '<svg class="tree-icon icon-folder" viewBox="0 0 16 16" fill="currentColor"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"/></svg>';
      var fileSvg = '<svg class="tree-icon icon-file" viewBox="0 0 16 16" fill="currentColor"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"/></svg>';

      function formatBytes(b) {
        var n = parseInt(b, 10);
        if (n < 1024) return n + ' B';
        if (n < 1024 * 1024) return (n / 1024).toFixed(1) + ' KB';
        return (n / (1024 * 1024)).toFixed(1) + ' MB';
      }

      function renderTree(node, container, isRoot) {
        // Sort dirs first, then files
        var dirNames = Object.keys(node.dirs).sort();
        var sortedFiles = node.files.slice().sort(function(a,b) { return a.name.localeCompare(b.name); });

        dirNames.forEach(function(name) {
          var dirEl = document.createElement('div');
          dirEl.className = 'tree-dir';

          var label = document.createElement('div');
          label.className = 'tree-dir-label';
          label.innerHTML = chevronSvg + folderSvg + '<span>' + name + '</span>';

          var children = document.createElement('div');
          children.className = 'tree-children';

          label.addEventListener('click', function() {
            var chev = label.querySelector('.tree-chevron');
            chev.classList.toggle('open');
            children.classList.toggle('open');
          });

          dirEl.appendChild(label);
          dirEl.appendChild(children);
          container.appendChild(dirEl);

          renderTree(node.dirs[name], children, false);
        });

        sortedFiles.forEach(function(f) {
          var fileEl = document.createElement('div');
          fileEl.className = 'tree-file';
          fileEl.innerHTML =
            fileSvg +
            '<a class="tree-file-link" href="' + f.viewUrl + '">' + f.name + '</a>' +
            '<span class="tree-file-size">' + formatBytes(f.bytes) + '</span>' +
            '<span class="tree-file-actions">' +
              '<a href="' + f.viewUrl + '">View</a>' +
              '<a href="' + f.editUrl + '">Edit</a>' +
            '</span>';
          container.appendChild(fileEl);
        });
      }

      var tree = buildTree(files);
      var container = document.getElementById('file-tree');
      container.className = 'tree-root';
      renderTree(tree, container, true);

      // Auto-expand root-level directories if there are few of them
      var rootDirs = container.querySelectorAll(':scope > .tree-dir');
      if (rootDirs.length <= 5) {
        rootDirs.forEach(function(d) {
          d.querySelector('.tree-chevron').classList.add('open');
          d.querySelector('.tree-children').classList.add('open');
        });
      }
    })();
  </script>
{% endblock %}
