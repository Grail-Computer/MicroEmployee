{% extends "layout.html" %}
{% block title %}Grail | Cron{% endblock %}
{% block content %}
  <h2>Cron</h2>
  <p class="section-desc">Manage scheduled tasks that run on a timer or cron expression.</p>

  <div class="grid mb-md">
    <div class="kv">
      <div class="k">Cron Enabled</div>
      <div class="v">
        {% if cron_enabled %}
          <span class="pill ok">enabled</span>
        {% else %}
          <span class="pill bad">disabled</span>
        {% endif %}
      </div>
      <div class="mt-sm text-muted" style="font-size: 12px;">
        Enable/disable in <a href="/admin/settings">Settings</a>.
      </div>
    </div>
    <div class="kv">
      <div class="k">Workspace ID</div>
      <div class="v">
        {% if workspace_id != "" %}
          <span class="pill">{{ workspace_id }}</span>
        {% else %}
          <span class="pill bad">missing</span>
        {% endif %}
      </div>
      <div class="mt-sm text-muted" style="font-size: 12px;">
        Pinned on the first valid Slack event. Mention Grail once if empty.
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="form-section-title">Add Job</div>
    <form method="post" action="/admin/cron/add">
      <label for="name">Name</label>
      <input id="name" name="name" type="text" placeholder="daily-summary" />

      <label for="channel_id">Channel ID</label>
      <input id="channel_id" name="channel_id" type="text" placeholder="C0123..." />

      <label for="thread_ts">Thread TS (optional)</label>
      <input id="thread_ts" name="thread_ts" type="text" placeholder="Leave blank to post in channel" />

      <label for="prompt_text">Prompt</label>
      <input id="prompt_text" name="prompt_text" type="text" placeholder="Summarize the last 50 messages..." />

      <label for="mode">Mode</label>
      <select id="mode" name="mode">
        <option value="agent" selected>Agent (Codex)</option>
        <option value="message">Message (post prompt as-is)</option>
      </select>

      <label for="schedule_kind">Schedule</label>
      <select id="schedule_kind" name="schedule_kind">
        <option value="every">Every N seconds</option>
        <option value="cron">Cron expression</option>
        <option value="at">At (unix seconds)</option>
      </select>

      <label for="every_seconds">Every seconds</label>
      <input id="every_seconds" name="every_seconds" type="number" min="1" placeholder="3600" />

      <label for="cron_expr">Cron expression</label>
      <input id="cron_expr" name="cron_expr" type="text" placeholder="0 9 * * *" />

      <label for="at_ts">At timestamp</label>
      <input id="at_ts" name="at_ts" type="number" min="1" placeholder="1700000000" />

      <div style="display:flex; align-items:center; gap:10px; margin-top:14px;">
        <input id="enabled" name="enabled" type="checkbox" value="1" checked style="width:auto;" />
        <label for="enabled" style="margin:0; color: var(--text);">Enabled</label>
      </div>

      <button type="submit">Create Job</button>
    </form>
  </div>

  <h3>Jobs</h3>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Enabled</th>
        <th>Name</th>
        <th>Mode</th>
        <th>Schedule</th>
        <th>Target</th>
        <th>Prompt</th>
        <th>Next Run</th>
        <th>Last Run</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for j in jobs %}
        <tr>
          <td style="font-family: var(--font-mono);">{{ j.id }}</td>
          <td>{% if j.enabled %}<span class="pill ok">yes</span>{% else %}<span class="pill bad">no</span>{% endif %}</td>
          <td>{{ j.name }}</td>
          <td class="text-muted">{{ j.mode }}</td>
          <td class="text-muted" style="font-family: var(--font-mono); font-size: 12px;">{{ j.schedule }}</td>
          <td class="text-muted" style="font-family: var(--font-mono); font-size: 12px;">
            {{ j.channel_id }}
            {% if j.thread_ts != "" %}
              <div class="mt-sm">thread={{ j.thread_ts }}</div>
            {% else %}
              <div class="mt-sm">(channel)</div>
            {% endif %}
          </td>
          <td style="max-width: 300px;" class="text-muted">{{ j.prompt_text }}</td>
          <td class="text-muted" style="white-space: nowrap;">{{ j.next_run_at }}</td>
          <td class="text-muted" style="white-space: nowrap;">{{ j.last_run_at }}</td>
          <td class="text-muted">
            {% if j.last_status != "" %}
              {{ j.last_status }}
            {% endif %}
            {% if j.last_error != "" %}
              <div class="mt-sm text-danger">{{ j.last_error }}</div>
            {% endif %}
          </td>
          <td>
            {% if j.enabled %}
              <form method="post" action="/admin/cron/{{ j.id }}/disable">
                <button type="submit" class="btn-sm">Disable</button>
              </form>
            {% else %}
              <form method="post" action="/admin/cron/{{ j.id }}/enable">
                <button type="submit" class="btn-sm">Enable</button>
              </form>
            {% endif %}
            <form method="post" action="/admin/cron/{{ j.id }}/delete">
              <button type="submit" class="btn-danger btn-sm mt-sm">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}
